# [中文](README_zh.md) | [English](README.md)

# OpticalCircleFitting

博士研究生期间我的第一个工作本打算在师兄的螺旋相称成像基础上进一步发展，但是我发现前人关于螺旋相称成像的工作已经很完备了，于是我开始了解螺旋相乘成像的数学/计算机视觉解释并注意到了在camera capture过程中被忽视的相位（梯度方向）。这是我的独立思考的第一个idea，我为它而骄傲。下面我会帮你入门并附上代码以及paper的数据。

1.首先你需要了解光学系统的傅里叶变换/卷积操作。 这在光学中常常被称为空间滤波spatial filtering，常用的有两种spatial filtering系统，一种是由两个透镜组成的4f系统实现，第二种通过将器件的透过率函数transmission function和单个透镜的相位叠加superpoisiton而实现.我在"证明4-f和单透镜.md"这个文件中对其机制进行了详细描述，并区分了这两种空间滤波系统的不同，其中superpoisiton的系统空间集成度很高，但存在无法避免的缺陷，而4f系统虽然空间上复杂，但是空间滤波效果最好。 

2.了解了通过光学实现卷积的操作后，你需要有一定的计算机视觉知识，明白梯度作为一种局域信息，往往可以通过对原图卷积一个很小的卷积核kernel而实现，由于光学系统是一种线性系统，兼容卷积这种线性操作，我们使用sobel算子来实现对梯度的提取（Canny算子较为复杂，需要非线性操作）。此外，计算机视觉中受限于采样率的限制，sobel算子只提取了0°，45°，90°，到315°这8个方向的梯度信息，而光学的卷积是一种作用在真实物理空间中的，连续的操作，这与cv中的离散操作不同，因此我们将sobelX+1i*sobelY拓展到了覆盖360°的全部角向也就是一个spiral phase，以提取更finer的梯度，这也是spiral phase contrast imaging的原理，证明过程在“菲涅尔衍射-汉克尔变换-螺旋相称成像.md”中。

从这里开始是我的独创性思考

3.在1中讲述了光学卷积系统有两种，但是基于superpoisition的系统存在一定的缺陷，其有一个从光轴中心（透镜中心）到外围不断变化，且变化越来越快的附加相位，这会导致两个问题，1.视场的缩小，这个变化的相位在靠近光轴中心的时候，变化不剧烈（最起码在gradient operator的范围内变化不剧烈，你可以认为我们的kernel很小，在kernel覆盖的一小块区域内部这个附加项存在，但是constant），但是当远离光轴的时候情况就会变化，这个时候尽快kernel很小，但是附加相位平方增长导致即使在很小的局部区域内附加相位也不再是一个常数，从而导致梯度计算的失败。2.相位/梯度方向的失真：cv中将卷积结果的强度视为gradient的强度，相位视为gradient的方向，即使是在靠近光轴部分，gradient提取操作成立，但是这并不代表附加相位没有影响，只是由于kernel太小，同一个kernel内的附加相位是常数，它可以被提取出来而已，但是不同的kenel之间附加相位可不一致，这会导致卷积结果的相位不再是梯度的方向。

所以如果想要利用gradient的相位，那么就需要使用4f系统以保证spatial filtering/optical convolution的结果的相位准确代表gradient的方向。

4.然后就是hough gradient method，它的原理是圆的梯度/法线永远指向圆心，因此我们在gradient map上面使用一个voter/accumulator,将法线/gradient延长，并统计交点，就会法线圆形边缘会相交于同一点进而导致这点的权重很高。但是非线性操作是光计算无法跨过的一座大山，我们无法将法线延长而不反向延长，我们也无法判断法线是否通过某一点而不是擦边绕过。这一度让我陷入了困惑。我曾一度认为这会使得我的idea胎死腹中，该死的光，计算机中的简单的if else，在光计算中难过登天，光计算就好像戴着镣铐起舞，能做的只有傅里叶变换的和卷积罢了。

5.我的思考结果是，电动力学中学过场的源和汇，我想要让圆上的法线汇聚到圆心处。这不就相当于汇吗？从一个电源出发，电磁波传波到一个圆/一个球，并且速度/波矢就是法线方向从圆心指向外围。如果我反过来思考，给这些gradient一个额外的相位，也就是让法线转过一定的角度，不就能让他们具有一样的相位，从而实现相干相涨。这很容易搞定，只需要给一个和spiral phase contrast imaging相反的spiarl phase就可以抵消掉gradient中的螺旋相位。这个kernel需要比我们待测的圆形还要大，这确实有点反常识，一般cv中使用的卷积算子/kernel都是很小的，因为他们需要测量的是局域信息，而且大的kernel带来的算力消耗也很大，这对于计算机来说是困难的，但是光计算的卷积，算力是唯一的优势！

6.但是当我真的实操的时候，我发现我错了，尽管可以在中心得到一个亮点，这亮点也太过于大了，几乎覆盖了半个圆的面积。我不能说我要做圆识别，要找到圆心，结果是圆心就在圆的内部，然后我说这个小圆就是圆心所在位置，这太不precise了。我思考了这个原因，结果是毕竟我使用了粗糙的卷积来替代hough gradient method中的voter，在cv中，一个法线通过圆心它对圆心的voter是1，擦过圆心，那么它对圆心的voter是0，但是这种非线性，一分为二的判断在光计算中不可能实现，我设计的基于卷积的accumulator毕竟不是voter，当gradient擦过圆心的时候，它仍然对voter起作用。

8.解决这个问题的灵感来源于费曼的路径积分。费马原理/最小作用量原理认为光从A点到达B点会走的路径是光程差的极值点，但是费曼认为光是一个球面波（惠更斯原理），光从A点到B点会走过所有的路径，例如路径 A \rarrow C \rarrow B,但是如果我们对这个路径做一个微扰\delta，尽管路径变化很小，但是对于光的波长来说不算小了，这会导致光程差发生剧烈变化，路径A \rarrow C \rarrow B和它的微扰路径的矢量叠加类似于混沌态的随机向量叠加结果是0，这类似于一个box里面的空气分子无时无刻不再发生热运动，但是我们认为宏观上空气是静止的一样，因为他们的速度抵消了。只有处于极值点（光程差/相位随路径变化为0），路径和微扰路径的光程差为0，进而相干相长，才得以被观测。如果当gradient擦过圆心的时候，我们给他们一个随机、混沌的微扰，让他们相干相消呢？

9.因此，我在基于卷积的accumulator基础上从内向外一圈又一圈的乘以1,-1,1,-1,1,-1（或者说相位0,\pi,0,\pi）,这样对于圆心，仍然和之前一样没有变化，但是对于圆心外围的一些点，就会给他们0，\pi,0,\pi的随机相位，使得他们进入一种类似于混沌态，从而相干相消。

10.此外，还会给我们一些惊喜，圆环的梯度分为内圆和外圆，方向是相反的（指向圆心和背离圆心），这在hough gradient method中不是问题，背离圆心的直接忽略，但是在我们的accumulator中是个大问题，当内环和外环的gradient叠加时，相反的相位会使得他们相干相消，无法在圆心处产生亮点。但是如果加上周期性变换的0，\pi相位，而且内环和外环恰好同时落在两个不同的区域，一个落在0，另一个落在pi，就会使得之前的相干相消变为相干相长（相反的gradient变为同向的gradient）。但是如果内环和外环恰好同时落在0的区域或者恰好同时落在pi的区域，那么我们只能得到外环减去内环的强度了（由于外环比内环大，这时候仍然能够得到亮点，只是不够强）。这个需要依靠运气，将不能识别环形，改为了50%概率实现识别环形。

11.从我的paper来看，实际上只需要两个具有pi相位差的透光的环就可以实现圆拟合的功能。

12.我的一个展望，通过圆识别的机器人实现对癌细胞的识别与治疗。当前的纳米机器人，要么是通过识别癌细胞表面的某些靶点蛋白，要么是通过癌细胞附近的ph值或局部温度来接近癌细胞并释放内容药物。前者和靶向药一样，定向筛选会导致耐药性癌细胞占多数进而药物失效，后者感觉不太靠谱。医学上对癌细胞判断最有信服力的还是通过穿刺，活检获得切片进行形态学观察，而癌细胞的一个很大特征就是核质比增大。

目前一些课题组已经能偶实现，通过激光照射铂片，可以实现铂片的弯曲进而给纳米机器人创造动力。我的设想是将上转换纳米分子Ucnps置于双环圆拟合装置的圆心处，后边使用三至四个铂片。当外部使用红或者红外光（该波段人体组织透过率高）照射的时候，UCNPs会产生更高频率的光作为探照灯，由于UCNPs体积很小，从这点发出的光可以认为是空间相干光，反射到细胞上回来的光经过双环圆拟合可以得到亮点，亮点对应细胞核的位置，强度对应细胞核的体积（圆形越大，则gradient越多，圆心处accumulator收集到的法线越多），亮点打在对应的铂片上，进而使得铂片弯曲产生动力向癌变细胞游去实现识别。

当然这个东西听起来非常不靠谱，比如空间滤波怎么实现，小圆细胞癌症之外的很多细胞形状不规则、不是圆形，细胞膜有没有可能造成干扰。如果是内部器官的癌症，怎么把红外光照射到患处。我这里只是抛砖引玉，讲一个故事。期待研究人员的智慧。

如果有问题或者不清楚的地方，可以给邮件联系我：652023340017@smail.nju.edu.cn